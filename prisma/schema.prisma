generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Role {
  id        String     @id @default(cuid())
  name      String     @unique // "RESIDENT", "ADMIN", "SUPERADMIN", "SECURITY"
  residents Resident[]
  createdAt DateTime   @default(now())
}

model Announcement {
  id          String       @id @default(cuid())
  title       String
  date        DateTime     @default(now())
  category    String       // "maintenance", "event", "general", "urgent"
  priority    String       @default("normal") // "low", "normal", "high"
  summary     String
  body        String
  author      String
  link        String?
  linkText    String?
  published   Boolean      @default(true)
  eventConfig   EventConfig?
  sportsConfig  SportsConfig?
  notifications Notification[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Resident {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  phone        String
  block        Int      // 1, 2, 3, or 4
  flatNumber   String   // e.g., "101", "G2"
  residentType String   // "OWNER" or "TENANT"
  isApproved   Boolean  @default(false)
  googleImage  String?
  roleId       String
  role         Role     @relation(fields: [roleId], references: [id])
  rsvps                Rsvp[]
  sportsRegistrations  SportsRegistration[]
  notifications        Notification[]
  issues               Issue[]
  closedIssues         Issue[]  @relation("ClosedIssues")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model EventConfig {
  id             String       @id @default(cuid())
  announcementId String       @unique
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  mealType       String       // "breakfast", "lunch", "dinner"
  rsvpDeadline   DateTime
  menuItems      MenuItem[]
  rsvps          Rsvp[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model MenuItem {
  id            String      @id @default(cuid())
  eventConfigId String
  eventConfig   EventConfig @relation(fields: [eventConfigId], references: [id], onDelete: Cascade)
  name          String
  pricePerPlate Float
  sortOrder     Int         @default(0)
  rsvpItems     RsvpItem[]
  createdAt     DateTime    @default(now())
}

model Rsvp {
  id            String      @id @default(cuid())
  eventConfigId String
  eventConfig   EventConfig @relation(fields: [eventConfigId], references: [id], onDelete: Cascade)
  residentId    String
  resident      Resident    @relation(fields: [residentId], references: [id], onDelete: Cascade)
  items         RsvpItem[]
  paid          Boolean     @default(false)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([eventConfigId, residentId])
}

model RsvpItem {
  id         String   @id @default(cuid())
  rsvpId     String
  rsvp       Rsvp     @relation(fields: [rsvpId], references: [id], onDelete: Cascade)
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  plates     Int
  createdAt  DateTime @default(now())

  @@unique([rsvpId, menuItemId])
}

model SportsConfig {
  id                   String               @id @default(cuid())
  announcementId       String               @unique
  announcement         Announcement         @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  registrationDeadline DateTime
  sportItems           SportItem[]
  registrations        SportsRegistration[]
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
}

model SportItem {
  id               String             @id @default(cuid())
  sportsConfigId   String
  sportsConfig     SportsConfig       @relation(fields: [sportsConfigId], references: [id], onDelete: Cascade)
  name             String
  sortOrder        Int                @default(0)
  participantSports ParticipantSport[]
  createdAt        DateTime           @default(now())
}

model SportsRegistration {
  id             String       @id @default(cuid())
  sportsConfigId String
  sportsConfig   SportsConfig @relation(fields: [sportsConfigId], references: [id], onDelete: Cascade)
  residentId     String
  resident       Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)
  participants   Participant[]
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([sportsConfigId, residentId])
}

model Participant {
  id                   String             @id @default(cuid())
  sportsRegistrationId String
  sportsRegistration   SportsRegistration @relation(fields: [sportsRegistrationId], references: [id], onDelete: Cascade)
  name                 String
  ageCategory          String             // "kid", "teen", "adult"
  sports               ParticipantSport[]
  createdAt            DateTime           @default(now())
}

model ParticipantSport {
  id            String      @id @default(cuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  sportItemId   String
  sportItem     SportItem   @relation(fields: [sportItemId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@unique([participantId, sportItemId])
}

model Visitor {
  id            String         @id @default(cuid())
  name          String
  phone         String?
  email         String?
  vehicleNumber String?
  visitingBlock Int
  visitingFlat  String
  status        String         @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  notifications Notification[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Notification {
  id             String        @id @default(cuid())
  residentId     String
  resident       Resident      @relation(fields: [residentId], references: [id], onDelete: Cascade)
  announcementId String?
  announcement   Announcement? @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  visitorId      String?
  visitor        Visitor?      @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  issueId        String?
  issue          Issue?        @relation(fields: [issueId], references: [id], onDelete: Cascade)
  read           Boolean       @default(false)
  createdAt      DateTime      @default(now())

  @@unique([residentId, announcementId])
  @@index([residentId, read])
  @@index([visitorId])
  @@index([issueId])
}

model Issue {
  id               String    @id @default(cuid())
  title            String
  description      String
  category         String    // "ELECTRICAL", "PLUMBING", "OTHER"
  status           String    @default("OPEN") // "OPEN", "CLOSED"
  residentId       String
  resident         Resident  @relation(fields: [residentId], references: [id], onDelete: Cascade)
  closedBy         String?
  closedByResident Resident? @relation("ClosedIssues", fields: [closedBy], references: [id])
  closureComment   String?
  closedAt         DateTime?
  notifications    Notification[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([residentId])
  @@index([status])
}
